{% extends 'base.html' %}

{% block content %}
{% load static %}
<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    margin: 0;
    padding: 0;
  }

  .cart-container {
    display: flex;
    flex-direction: row;
    justify-content: center;
    gap: 2rem;
    padding: 2rem;
    background-color: #f3f4f6;
  }

  .cart-left {
    flex: 2;
    background-color: #ffffff;
    padding: 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .cart-left h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1rem;
  }

  .product-details-label {
    font-weight: 500;
    color: #4b5563;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }

  .cart-table {
    width: 100%;
  }

  .table-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
    font-weight: 600;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    color: #1f2937;
    text-align: left;
  }
  
  .table-header div:nth-child(2),
  .table-header div:nth-child(3) {
      text-align: right;
  }

  .cart-items {
    margin-top: 1rem;
  }

  .cart-item {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .item-details {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .item-details img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .item-details .item-info {
    display: flex;
    flex-direction: column;
  }

  .item-details h4 {
    margin: 0;
    font-size: 1rem;
    color: #1f2937;
  }

  .item-details p {
    margin: 0;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .subtotal {
    font-weight: 600;
    color: #1f2937;
    text-align: right;
  }

  .action-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }

  .action-buttons button, .action-buttons select {
    padding: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    background-color: #f9fafb;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .action-buttons button:hover {
    background-color: #e5e7eb;
  }

  .remove-btn {
    color: red;
    border: 1px solid red;
    background-color: #fff5f5;
  }

  .remove-btn:hover {
    background-color: #fde2e2;
  }

  .continue-shopping {
    display: inline-block;
    margin-top: 1.5rem;
    color: rgb(56, 189, 149);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
  }

  .continue-shopping:hover {
    color: rgb(34, 139, 99);
  }

  .cart-right {
    flex: 1;
    background-color: #ffffff;
    padding: 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .cart-right h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }

  .order-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .order-section p {
    margin: 0.5rem 0;
    color: #4b5563;
  }

  .order-section a {
    color: rgb(56, 189, 149);
    text-decoration: none;
    font-weight: 500;
  }

  .order-section select {
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    font-size: 1rem;
  }

  .price-summary h1 {
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1.5rem;
  }

  .price-summary p {
    display: flex;
    justify-content: space-between;
    margin: 0.75rem 0;
    color: #4b5563;
  }

  .price-summary p strong {
    font-size: 1.25rem;
    color: #1f2937;
  }

  .green-text {
    color: rgb(56, 189, 149);
    font-weight: 600;
  }

  .place-order-btn {
    width: 100%;
    background-color: rgb(56, 189, 149);
    color: #ffffff;
    padding: 1rem;
    border: none;
    border-radius: 9999px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .place-order-btn:hover {
    background-color: rgb(34, 139, 99);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .cart-container {
      flex-direction: column;
      padding: 1rem;
    }
  }
</style>

<div class="cart-container">
  <div class="cart-left">
    <h1>Shopping Cart <span id="cart-count-page">0</span></h1>
    <p class="product-details-label">Product Details</p>

    <div class="cart-table">
      <div class="table-header">
        <div>Product Details</div>
        <div>Subtotal</div>
        <div>Action</div>
      </div>
      <div class="cart-items" id="cart-items"></div>
      <a href="{% url 'food' %}" class="continue-shopping">← Continue Shopping</a>
    </div>
  </div>

  <div class="cart-right">
    <h2>Order Summary</h2>

    <div class="order-section">
      <p><strong>DELIVERY ADDRESS</strong></p>
      <!-- Simple address input (feel free to replace with your address picker) -->
      <input id="delivery-address" required type="text" placeholder="Enter your delivery address" style="width:100%;padding:.5rem;border:1px solid #ddd;border-radius:8px;">
    </div>

    <div class="order-section">
      <p><strong>PAYMENT METHOD</strong></p>
      <select id="payment-method" style="width:100%;padding:.5rem;border:1px solid #ddd;border-radius:8px;">
        <option>Cash On Delivery</option>
        <option>Transfer</option>
        <option>Debit Card</option>
      </select>
    </div>

    <div class="price-summary">
      <p>Items <span id="item-count">0 Items</span></p>
      <p>Shipping Fee <span class="green-text">Free</span></p>
      <p>Price <span id="price-total">0.00 birr</span></p>
      <p>Tax (2%) <span id="tax-amount">0.00 birr</span></p>
      <p><strong>Total Amount: <span id="total-amount">0.00 birr</span></strong></p>
    </div>

    <button class="place-order-btn">Place Order</button>
  </div>
</div>

<!-- Optional: a simple notification element -->
<div id="notification" style="position:fixed;right:16px;bottom:16px;background:#4CAF50;color:#fff;padding:.6rem .9rem;border-radius:8px;opacity:0;transition:opacity .25s;pointer-events:none;"></div>

<script>
(function () {
  const IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};
  const LOGIN_URL = "{% url 'login' %}?next={{ request.path|urlencode }}";
  const PLACE_ORDER_URL = "{% url 'place_order' %}"; // or 'deliveryApp:place_order' if namespaced

  function getCart(){ try { return JSON.parse(localStorage.getItem('cart')) || {}; } catch { return {}; } }
  function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }
  function formatBirr(n){ return `${Number(n||0).toFixed(2)} birr`; }
  function showNotification(msg="✅ Done", color="#4CAF50"){
    const el=document.getElementById("notification"); if(!el) return;
    el.textContent=msg; el.style.backgroundColor=color; el.style.opacity="1";
    setTimeout(()=>{el.style.opacity="0";}, 2500);
  }
  function getCookie(name){ let v=null; if(document.cookie){ for(const c of document.cookie.split(';')){ const t=c.trim(); if(t.startsWith(name+'=')){ v=decodeURIComponent(t.slice(name.length+1)); break; }}} return v; }

  function updateCartCount() {
    const cart = getCart();
    const total = Object.values(cart).reduce((s, it) => s + (Number(it.quantity) || 0), 0);
    const h = document.getElementById('cart-count');
    const p = document.getElementById('cart-count-page');
    if (h) h.textContent = total;
    if (p) p.textContent = total;
  }

  function renderCart() {
    const cart = getCart();
    const list = document.getElementById('cart-items');
    const itemCountDisplay = document.getElementById('item-count');
    const priceTotal = document.getElementById('price-total');
    const taxAmount = document.getElementById('tax-amount');
    const totalAmount = document.getElementById('total-amount');
    if (!list) return;

    list.innerHTML = '';
    let total = 0, count = 0;

    for (const [key, item] of Object.entries(cart)) {
      const qty = Number(item.quantity || 0);
      const price = Number(item.price || 0);
      const sub = qty * price;
      total += sub; count += qty;

      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <div class="item-details">
          <img src="${item.image || ''}" alt="${item.name || ''}">
          <div class="item-info">
            <h4>${item.name || ''}</h4>
            <p>${formatBirr(price)} x ${qty}</p>
          </div>
        </div>
        <div class="subtotal">${formatBirr(sub)}</div>
        <div class="action-buttons">
          <button class="remove-btn" data-id="${key}">Remove</button>
        </div>
      `;
      list.appendChild(div);
    }

    const tax = total * 0.02, grand = total + tax;
    if (itemCountDisplay) itemCountDisplay.textContent = `${count} Items`;
    if (priceTotal) priceTotal.textContent = formatBirr(total);
    if (taxAmount) taxAmount.textContent = formatBirr(tax);
    if (totalAmount) totalAmount.textContent = formatBirr(grand);

    updateCartCount();

    list.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const cart = getCart();
        const name = cart[id]?.name || 'Item';
        delete cart[id];
        saveCart(cart);
        renderCart();
        showNotification(`❌ ${name} removed from cart`, "red");
      });
    });
  }

  async function placeOrder() {
    if (!IS_AUTHENTICATED) { window.location.href = LOGIN_URL; return; }
    const cart = getCart();
    if (!Object.keys(cart).length) { showNotification("Cart is empty!", "red"); return; }

    // Build payload using numeric ids we stored
    const items = [];
    for (const item of Object.values(cart)) {
      const id = Number(item.id);
      if (!Number.isInteger(id)) continue;  // skip bad items
      items.push({
        id,
        name: item.name,
        quantity: Number(item.quantity || 1),
        price: Number(item.price || 0)
      });
    }
    if (!items.length) { showNotification("No valid items in cart.", "red"); return; }

    const address = (document.getElementById('delivery-address')?.value || "Default Address").trim();
    const payment = document.getElementById('payment-method')?.value || "Cash On Delivery";
    const total = items.reduce((s,i)=>s+(i.quantity*i.price),0);

    const btn = document.querySelector('.place-order-btn');
    if (btn) { btn.disabled = true; btn.textContent = "Placing..."; }

    try {
      const res = await fetch(PLACE_ORDER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ address, payment_method: payment, items, total })
      });

      if (res.status === 401) {
        const d = await res.json().catch(()=>({}));
        window.location.href = d.login_url || "{{ request.build_absolute_uri|default:'' }}";
        return;
      }

      const data = await res.json().catch(()=>({}));
      if (data.success) {
        localStorage.removeItem('cart');
        renderCart();
        showNotification("✅ Order placed successfully!");
        window.location.href = data.redirect_url || "{% url 'my_orders' %}";
        return;
      } else {
        showNotification(`❌ ${data.error || 'Failed to place order'}`, "red");
      }
    } catch (e) {
      showNotification("❌ Network error while placing order", "red");
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = "Place Order"; }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    renderCart();
    const placeBtn = document.querySelector('.place-order-btn');
    if (placeBtn) placeBtn.addEventListener('click', placeOrder);
  });
})();
</script>


{% endblock %}
