{% extends "seller/base.html" %}
{% load static %}

{% block title %}Seller Dashboard{% endblock %}

{% block extra_css %}
<style>
  /* Dashboard Main Container */
  .dashboard-container {
    animation: fadeIn 0.6s ease-in-out;
  }

  /* KPI Cards - Consistent with other pages */
  .cards { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
    gap: 1.5rem; 
    margin-bottom: 2rem; 
  }

  .card {
    background: var(--white);
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    box-shadow: var(--box-shadow-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, var(--primary-green), #45a049);
    transition: var(--transition);
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
  }

  .card:hover::before {
    width: 6px;
  }

  .card-content {
    flex: 1;
  }

  .card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.95rem;
    color: var(--sidebar-text);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .card .value {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    color: var(--dark-gray-text);
    line-height: 1;
  }

  .card .subtext {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
  }

  .card .icon {
    font-size: 2.5rem;
    color: var(--primary-green);
    opacity: 0.8;
    transition: var(--transition);
  }

  .card:hover .icon {
    transform: scale(1.1);
    opacity: 1;
  }

  /* Special card styles */
  .card.revenue .value {
    color: var(--primary-green);
  }

  .card.warning .value {
    color: #f59e0b;
  }

  .card.warning::before {
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }

  .card.danger .value {
    color: #ef4444;
  }

  .card.danger::before {
    background: linear-gradient(135deg, #ef4444, #dc2626);
  }

  /* Panels - Consistent with unified containers */
  .panel {
    background: var(--white);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    box-shadow: var(--box-shadow-light);
    border: 1px solid var(--light-gray);
    transition: var(--transition);
    animation: slideUp 0.6s ease-out;
  }

  .panel:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .panel h3 {
    margin: 0 0 1.5rem 0;
    font-size: 1.25rem;
    color: var(--dark-gray-text);
    font-weight: 700;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--light-gray);
  }

  .split { 
    display: grid; 
    grid-template-columns: 1.4fr 1fr; 
    gap: 1.5rem; 
  }

  @media (max-width: 1200px) { 
    .split { 
      grid-template-columns: 1fr; 
    } 
  }

  /* Table Styles - Consistent with other pages */
  .table-container {
    overflow-x: auto;
    border-radius: var(--border-radius-sm);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
  }

  th, td { 
    padding: 1rem 0.75rem; 
    border-bottom: 1px solid var(--light-gray); 
    font-size: 0.95rem; 
    text-align: left;
  }

  th { 
    font-weight: 600; 
    background: #fafafa;
    color: var(--sidebar-text);
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
  }

  tbody tr {
    transition: var(--transition);
  }

  tbody tr:hover {
    background-color: rgba(76, 175, 80, 0.03);
  }

  /* Badges - Consistent styling */
  .badge { 
    display: inline-block; 
    padding: 0.35rem 0.75rem; 
    border-radius: 20px; 
    font-size: 0.8rem; 
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge.ok { 
    background: rgba(16, 185, 129, 0.1); 
    color: #065f46; 
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .badge.warn { 
    background: rgba(239, 68, 68, 0.1); 
    color: #7f1d1d; 
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  /* Chart Container */
  .chart-container {
    height: 260px;
    position: relative;
  }

  /* Data not available state */
  .data-not-available {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  .data-not-available i {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 1rem;
  }

  .data-not-available p {
    margin: 0;
    font-size: 1rem;
  }

  /* Animations */
  @keyframes fadeIn {
    from { 
      opacity: 0; 
      transform: translateY(20px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

  @keyframes slideUp {
    from { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

  /* Stagger animation for cards */
  .card:nth-child(1) { animation-delay: 0.1s; }
  .card:nth-child(2) { animation-delay: 0.2s; }
  .card:nth-child(3) { animation-delay: 0.3s; }
  .card:nth-child(4) { animation-delay: 0.4s; }
  .card:nth-child(5) { animation-delay: 0.5s; }
  .card:nth-child(6) { animation-delay: 0.6s; }

  /* Responsive Design */
  @media (max-width: 768px) {
    .cards {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .card {
      padding: 1.25rem;
    }
    
    .card .value {
      font-size: 1.75rem;
    }
    
    .card .icon {
      font-size: 2rem;
    }
    
    .panel {
      padding: 1.25rem;
    }
    
    th, td {
      padding: 0.75rem 0.5rem;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    .cards {
      grid-template-columns: 1fr;
    }
    
    .card {
      padding: 1rem;
    }
    
    .split {
      gap: 1rem;
    }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .empty-state i {
    font-size: 3rem;
    color: #ddd;
    margin-bottom: 1rem;
  }

  .empty-state p {
    margin: 0;
    font-size: 1rem;
  }

  /* Stats Highlights */
  .stats-highlight {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--light-gray);
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-green);
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--sidebar-text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
</style>
{% endblock %}

{% block content %}

<div class="dashboard-container">
  <!-- Welcome Header -->
  <div class="unified-header" style="margin-bottom: 2rem;">
    <div>
      <h2>Dashboard Overview</h2>
      <p style="margin: 0; color: #666; font-size: 14px;">
        Welcome back! Here's what's happening with your business today.
      </p>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <span style="color: #666; font-size: 14px;">{% now "F j, Y" %}</span>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="cards">
    <div class="card">
      <div class="card-content">
        <h4>Total Products</h4>
        <p class="value">{{ total_products|default:"0" }}</p>
        <p class="subtext">Active in your stores</p>
      </div>
      <i class="fa-solid fa-boxes-stacked icon"></i>
    </div>

    <div class="card">
      <div class="card-content">
        <h4>In Stock</h4>
        <p class="value">{{ in_stock|default:"0" }}</p>
        <p class="subtext">Available for sale</p>
      </div>
      <i class="fa-solid fa-circle-check icon"></i>
    </div>

    <div class="card warning">
      <div class="card-content">
        <h4>Out of Stock</h4>
        <p class="value">{{ out_stock|default:"0" }}</p>
        <p class="subtext">Need restocking</p>
      </div>
      <i class="fa-solid fa-triangle-exclamation icon"></i>
    </div>

    <div class="card">
      <div class="card-content">
        <h4>Your Restaurants</h4>
        <p class="value">{{ total_restaurants|default:"0" }}</p>
        <p class="subtext">Active locations</p>
      </div>
      <i class="fa-solid fa-store icon"></i>
    </div>

    <div class="card">
      <div class="card-content">
        <h4>Total Orders</h4>
        <p class="value">{{ total_orders|default:"0" }}</p>
        <p class="subtext">All time orders</p>
      </div>
      <i class="fa-solid fa-list-check icon"></i>
    </div>

    <div class="card revenue">
      <div class="card-content">
        <h4>Total Revenue</h4>
        <p class="value">{{ total_revenue|default:"0.00" }}</p>
        <p class="subtext">ETB total earnings</p>
      </div>
      <i class="fa-solid fa-sack-dollar icon"></i>
    </div>
  </div>

  <!-- Chart + Recent Products -->
  <div class="split">
    <div class="panel">
      <h3>Products Added (Last 6 Months)</h3>
      <div class="chart-container">
        {% if chart_labels and chart_values %}
          <canvas id="productsChart"></canvas>
        {% else %}
          <div class="data-not-available">
            <i class="fa-solid fa-chart-line"></i>
            <p>No data available for chart</p>
            <small>Start adding products to see analytics</small>
          </div>
        {% endif %}
      </div>
      {% if chart_labels and chart_values %}
      <div class="stats-highlight">
        <div class="stat-item">
          <div class="stat-value">+{{ recent_growth|default:"0" }}%</div>
          <div class="stat-label">Growth</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ monthly_average|default:"0" }}</div>
          <div class="stat-label">Monthly Avg</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ total_products|default:"0" }}</div>
          <div class="stat-label">Total</div>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="panel">
      <h3>Recent Products</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th>Price</th>
              <th>Status</th>
              <th>Added</th>
            </tr>
          </thead>
          <tbody>
            {% if recent_products %}
              {% for p in recent_products %}
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    {% if p.image1 %}
                    <img src="{{ p.image1.url }}" alt="{{ p.name }}" style="width: 30px; height: 30px; border-radius: 4px; object-fit: cover;">
                    {% else %}
                    <div style="width: 30px; height: 30px; background: #f3f4f6; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                      <i class="fa-solid fa-image" style="color: #9ca3af; font-size: 12px;"></i>
                    </div>
                    {% endif %}
                    <span style="font-weight: 500;">{{ p.name|truncatechars:20 }}</span>
                  </div>
                </td>
                <td>{{ p.product_price }} ETB</td>
                <td>
                  {% if p.in_stock %}
                    <span class="badge ok">In Stock</span>
                  {% else %}
                    <span class="badge warn">Out of Stock</span>
                  {% endif %}
                </td>
                <td>{{ p.created_at|date:"M d" }}</td>
              </tr>
              {% endfor %}
            {% else %}
            <tr>
              <td colspan="4" class="empty-state">
                <i class="fa-solid fa-box-open"></i>
                <p>No products added yet</p>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      const canvas = document.getElementById('productsChart');
      if (!canvas || typeof Chart === 'undefined') {
        console.log('Chart.js not loaded or canvas not found');
        return;
      }

      const ctx = canvas.getContext('2d');

      // Ensure labels/values are arrays
      let labels = {{ chart_labels|default:"[]"|safe }};
      let values = {{ chart_values|default:"[]"|safe }};
      
      if (typeof labels === 'string') { 
        try { labels = JSON.parse(labels); } catch(e) {
          console.log('Error parsing labels:', e);
          labels = [];
        } 
      }
      
      if (typeof values === 'string') { 
        try { values = JSON.parse(values); } catch(e) {
          console.log('Error parsing values:', e);
          values = [];
        } 
      }
      
      if (!Array.isArray(labels)) labels = [];
      if (!Array.isArray(values)) values = [];

      // Match lengths to prevent Chart warnings
      if (values.length > labels.length) values = values.slice(0, labels.length);

      // Create gradient for chart
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
      gradient.addColorStop(1, 'rgba(16, 185, 129, 0.05)');

      try {
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Products Added',
              data: values,
              tension: 0.4,
              fill: true,
              borderWidth: 3,
              borderColor: 'rgba(16, 185, 129, 0.9)',
              backgroundColor: gradient,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#fff',
              pointBorderColor: 'rgba(16, 185, 129, 0.9)',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { 
                  display: false,
                  drawBorder: false
                },
                ticks: {
                  color: '#6b7280'
                }
              },
              y: {
                beginAtZero: true,
                ticks: { 
                  precision: 0,
                  color: '#6b7280'
                },
                grid: { 
                  color: 'rgba(0,0,0,0.04)',
                  drawBorder: false
                }
              }
            },
            plugins: {
              legend: { 
                display: false 
              },
              tooltip: { 
                mode: 'index', 
                intersect: false,
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                titleColor: '#1f2937',
                bodyColor: '#4b5563',
                borderColor: '#e5e7eb',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: false
              }
            },
            interaction: {
              intersect: false,
              mode: 'nearest'
            }
          }
        });
      } catch (error) {
        console.log('Error creating chart:', error);
      }

      // Add hover effects to cards
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-5px)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
        });
      });
    });
  })();
</script>

{% endblock %}